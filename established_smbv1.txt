/*
Name: Internal Host Activity - Established SMBv1 Connection
Description:
  Detects actual established TCP connections utilizing the highly vulnerable SMBv1 protocol.
  This is a critical alert, as a confirmed connection to an SMBv1 service implies successful interaction
  and is a strong indicator of active malicious activity or a severe policy violation.
MITRE ATT&CK Mapping:
  T1210 - Exploitation of Remote Services: If an adversary is establishing a connection for exploitation.
Severity Score: 5
Rationale:
  A confirmed established connection over SMBv1 is an extremely high-confidence indicator of active risk,
  given its severe known vulnerabilities.
*/
SELECT
    'established_smbv1' AS report_name,
    SrcIp,
    DestIp,
    MasterProtocol,
    SubProtocol,
    count() AS Total_Established_SMBv1_Connections,
    min(Timestamp) AS First_Connection_Time,
    max(Timestamp) AS Last_Connection_Time,
    format('Src {} established {} SMBv1 connection(s) to {}. Critical SMBv1 use detected.', SrcIp, toString(count()), DestIp) AS description,
    'T1210' AS mitre_mapping,
    5 AS severity_score,
    arrayStringConcat(arraySlice(arraySort(groupUniqArray(DestIp || ':' || toString(DestPort) || ':' || MasterProtocol || ':' || SubProtocol)), 1, 10), ', ') AS Sample_Dest_IP_Ports_List
FROM
    dragonfly.dragonflyClusterScoresJoin
WHERE
    DestIpCategory = 'private'
    AND Timestamp >= now() - toIntervalHour(1)
    AND (
        MasterProtocol IN ('SMBv1', 'NetBIOS')
        AND SubProtocol = 'SMBv1'
    )
    AND ClientToServerPacketCount > 1
    AND ServerToClientPacketCount > 1
    AND bitAnd(ClientToServerTcpFlags, 16) = 16
    AND bitAnd(ServerToClientTcpFlags, 18) = 18
    AND ClientToServerDuration >= 1000
GROUP BY
    SrcIp, DestIp, MasterProtocol, SubProtocol
HAVING
    count() >= 1
ORDER BY
    Total_Established_SMBv1_Connections DESC
LIMIT 50;
/*
Name: Internal Host Recon - Target Port Sweep
Description:
  Identifies an internal source IP performing a stealthy SYN scan against a high number of unique ports on a single destination IP.
  This suggests targeted reconnaissance to identify open services and potential vulnerabilities on a specific host.
MITRE ATT&CK Mapping:
  T1046 - Network Service Discovery: Directly applicable as the attacker is trying to find what services are running on a specific host.
Severity Score: 4
Rationale:
  Very strong indicator of targeted reconnaissance. Targeting many ports on a *single host* is highly indicative of scanning a specific target for vulnerabilities.
  Less likely to be background noise.
*/
SELECT
    'port_sweep' AS report_name,
    SrcIp,
    DestIp,
    count(DISTINCT DestPort) AS Unique_DestPorts_Scanned,
    min(Timestamp) AS First_Scan_Attempt,
    max(Timestamp) AS Last_Attempt,
    format('Src {} performed stealthy SYN port sweep against {} targeting {} unique ports. Host/service discovery suspected.', SrcIp, DestIp, toString(count(DISTINCT DestPort))) AS description,
    'T1046' AS mitre_mapping,
    4 AS severity_score,
    arrayStringConcat(arraySlice(arraySort(groupUniqArray(DestIp || ':' || toString(DestPort))), 1, 10), ', ') AS Sample_Dest_IP_Ports_List
FROM
    dragonfly.dragonflyClusterScoresJoin
WHERE
    DestIpCategory = 'private'
    AND Timestamp >= now() - toIntervalHour(1)
    AND ClientToServerPacketCount = 1
    AND ServerToClientPacketCount <= 1
    AND ClientToServerTcpFlags = 2
    AND (bitAnd(ServerToClientTcpFlags, 18) = 18 OR bitAnd(ServerToClientTcpFlags, 20) = 20 OR ServerToClientTcpFlags = 0)
    AND ClientToServerDuration < 500
GROUP BY
    SrcIp, DestIp
HAVING
    count(DISTINCT DestPort) > 10
ORDER BY
    Unique_DestPorts_Scanned DESC
LIMIT 50;